name: breakpad

on:
  push:
    paths:
      - '.github/workflows/breakpad.yml'
      - 'ports/breakpad/**'
  pull_request:
    paths:
      - '.github/workflows/breakpad.yml'
      - 'ports/breakpad/**'

jobs:
  build-ubuntu:
    name: Build on ubuntu
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, ubuntu-22.04, ubuntu-20.04]
        triplet: [x64-linux]

    steps:
      - uses: actions/checkout@v4
      
      - name: Install vcpkg-tool
        shell: bash
        run: ./bootstrap-vcpkg.sh

      - name: Build
        shell: bash
        run: |
          ./vcpkg install breakpad --triplet ${{ matrix.triplet }} \
          || (cat ./installed/vcpkg/issue_body.md && exit 1)

  build-macos:
    name: Build on macos
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-14, macos-13, macos-12]
        triplet: [x64-osx, arm64-osx]

    steps:
      - uses: actions/checkout@v4

      - name: Install vcpkg-tool
        shell: bash
        run: ./bootstrap-vcpkg.sh

      - name: Build
        shell: bash
        run: |
          ./vcpkg install breakpad --triplet ${{ matrix.triplet }} \
          || (cat ./installed/vcpkg/issue_body.md && exit 1)

  build-windows:
    name: Build on windows
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-2022, windows-2019]
        triplet: 
          - x64-windows
          - x64-windows-static-md
          - x86-windows
          - x86-windows-static-md

    steps:
      - uses: actions/checkout@v4

      - name: Install vcpkg-tool
        shell: pwsh
        run: .\bootstrap-vcpkg.bat

      - name: Build
        shell: bash
        run: |
          ./vcpkg.exe install breakpad[tools] --triplet ${{ matrix.triplet }} \
          || (cat ./installed/vcpkg/issue_body.md && exit 1)

      - name: Check for executables
        shell: pwsh
        working-directory: installed/${{ matrix.triplet }}/tools/breakpad
        run: |
          $executables = @('dump_syms.exe', 'google_converter.exe', 'sym_upload.exe')
          foreach ($exe in $executables) {
              if (-Not (Test-Path $exe)) {
                  Write-Host "Error: $exe does not exist."
                  exit 1
              }
          }
          Write-Host "All specified executables exist."
